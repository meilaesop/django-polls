{% extends 'polls/base.html' %}
{% load static %}

{% block title %}{{ question.question_text }} | 投票结果{% endblock %}

{% block page_title %}投票结果{% endblock %}
{% block page_subtitle %}查看投票统计和详细数据{% endblock %}

{% block extra_css %}
<style>
    /* 投票结果页面专用样式 */
    .results-container {
        max-width: 900px;
        margin: 0 auto;
    }

    .results-card {
        background: var(--card-bg);
        border: 1px solid rgba(99, 102, 241, 0.15);
        border-radius: 25px;
        padding: 40px;
        box-shadow: var(--shadow-hover);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        position: relative;
        overflow: hidden;
        animation: fadeInUp 0.6s ease-out;
        margin-bottom: 30px;
    }

    .results-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: var(--primary-gradient);
    }

    .results-header {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(99, 102, 241, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 20px;
    }

    .poll-title {
        font-size: 1.8rem;
        font-weight: 800;
        color: var(--text-primary);
        margin-bottom: 15px;
        line-height: 1.4;
        background: linear-gradient(135deg, var(--text-primary) 0%, #4f46e5 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .poll-meta {
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-secondary);
        font-size: 14px;
        padding: 6px 12px;
        background: rgba(99, 102, 241, 0.08);
        border-radius: 10px;
    }

    .meta-item i {
        color: var(--primary-color);
        font-size: 14px;
    }

    .result-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 700;
        background: var(--primary-gradient);
        color: white;
        box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
    }

    /* 投票统计概览 */
    .results-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .overview-card {
        background: white;
        border: 1px solid rgba(99, 102, 241, 0.1);
        border-radius: 18px;
        padding: 25px;
        text-align: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .overview-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(99, 102, 241, 0.1);
        border-color: rgba(99, 102, 241, 0.2);
    }

    .overview-card.highlight {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
        border-color: var(--primary-color);
    }

    .overview-icon {
        width: 60px;
        height: 60px;
        margin: 0 auto 15px;
        background: var(--primary-gradient);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .overview-icon i {
        color: white;
        font-size: 24px;
    }

    .overview-value {
        font-size: 2.5rem;
        font-weight: 800;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        line-height: 1;
        margin-bottom: 8px;
    }

    .overview-label {
        font-size: 14px;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* 投票结果图表 */
    .results-chart {
        background: white;
        border: 1px solid rgba(99, 102, 241, 0.1);
        border-radius: 18px;
        padding: 30px;
        margin-bottom: 40px;
        transition: all 0.3s ease;
    }

    .results-chart:hover {
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .chart-title {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .chart-title i {
        color: var(--primary-color);
    }

    .chart-controls {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .chart-btn {
        padding: 8px 16px;
        border: 1px solid rgba(99, 102, 241, 0.2);
        border-radius: 10px;
        background: white;
        color: var(--text-primary);
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .chart-btn:hover {
        background: var(--primary-gradient);
        color: white;
        border-color: transparent;
        transform: translateY(-2px);
    }

    .chart-btn.active {
        background: var(--primary-gradient);
        color: white;
        border-color: transparent;
    }

    .chart-container {
        height: 300px;
        position: relative;
        margin-bottom: 20px;
    }

    .chart-bars {
        height: 100%;
        display: flex;
        align-items: flex-end;
        gap: 10px;
        padding: 0 20px;
    }

    .chart-bar-wrapper {
        flex: 1;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end;
        position: relative;
    }

    .chart-bar {
        width: 80%;
        background: var(--primary-gradient);
        border-radius: 8px 8px 0 0;
        transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        cursor: pointer;
    }

    .chart-bar:hover {
        opacity: 0.9;
        transform: scaleY(1.05);
    }

    .chart-bar.winner {
        background: linear-gradient(135deg, #f59e0b 0%, #ec4899 100%);
        box-shadow: 0 5px 15px rgba(245, 158, 11, 0.3);
    }

    .chart-bar-value {
        position: absolute;
        top: -30px;
        left: 0;
        right: 0;
        text-align: center;
        font-weight: 700;
        font-size: 14px;
        color: var(--text-primary);
    }

    .chart-bar-label {
        margin-top: 10px;
        font-size: 12px;
        color: var(--text-secondary);
        text-align: center;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .chart-legend {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 15px;
        padding-top: 20px;
        border-top: 1px solid rgba(99, 102, 241, 0.1);
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: var(--text-secondary);
    }

    .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 3px;
        background: var(--primary-gradient);
    }

    .legend-item.winner .legend-color {
        background: linear-gradient(135deg, #f59e0b 0%, #ec4899 100%);
    }

    /* 详细结果列表 */
    .results-list {
        margin-bottom: 40px;
    }

    .result-item {
        background: white;
        border: 1px solid rgba(99, 102, 241, 0.1);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .result-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(99, 102, 241, 0.1);
        border-color: rgba(99, 102, 241, 0.2);
    }

    .result-item.winner {
        border-left: 4px solid #f59e0b;
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, rgba(236, 72, 153, 0.05) 100%);
    }

    .result-rank {
        position: absolute;
        top: 20px;
        left: 20px;
        width: 32px;
        height: 32px;
        background: var(--primary-gradient);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 800;
        font-size: 14px;
    }

    .result-item.winner .result-rank {
        background: linear-gradient(135deg, #f59e0b 0%, #ec4899 100%);
        box-shadow: 0 5px 15px rgba(245, 158, 11, 0.3);
    }

    .result-content {
        margin-left: 45px;
    }

    .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        flex-wrap: wrap;
        gap: 10px;
    }

    .result-title {
        font-weight: 700;
        color: var(--text-primary);
        font-size: 16px;
        margin: 0;
    }

    .result-stats {
        display: flex;
        gap: 20px;
        align-items: center;
    }

    .result-votes {
        background: rgba(99, 102, 241, 0.1);
        padding: 6px 15px;
        border-radius: 15px;
        font-size: 14px;
        font-weight: 700;
        color: var(--primary-color);
        min-width: 80px;
        text-align: center;
    }

    .result-percentage {
        font-size: 18px;
        font-weight: 800;
        color: var(--text-primary);
        min-width: 60px;
    }

    .result-progress {
        height: 8px;
        background: rgba(99, 102, 241, 0.1);
        border-radius: 4px;
        overflow: hidden;
        position: relative;
        margin-top: 10px;
    }

    .result-progress-bar {
        height: 100%;
        background: var(--primary-gradient);
        border-radius: 4px;
        width: 0%;
        transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .result-item.winner .result-progress-bar {
        background: linear-gradient(135deg, #f59e0b 0%, #ec4899 100%);
    }

    /* 时间趋势（如果可用） */
    .time-trend {
        background: white;
        border: 1px solid rgba(99, 102, 241, 0.1);
        border-radius: 18px;
        padding: 30px;
        margin-bottom: 40px;
    }

    .trend-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .trend-title {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .trend-title i {
        color: var(--primary-color);
    }

    .trend-chart {
        height: 200px;
        position: relative;
        border-radius: 10px;
        background: rgba(99, 102, 241, 0.05);
        padding: 20px;
        overflow: hidden;
    }

    .trend-line {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: rgba(99, 102, 241, 0.2);
    }

    .trend-points {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        top: 0;
    }

    .trend-point {
        position: absolute;
        width: 10px;
        height: 10px;
        background: var(--primary-color);
        border-radius: 50%;
        transform: translate(-50%, 50%);
    }

    .trend-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
        font-size: 12px;
        color: var(--text-secondary);
    }

    /* 用户投票信息 */
    .user-vote-info {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(29, 78, 216, 0.1) 100%);
        border: 1px solid #93c5fd;
        border-radius: 18px;
        padding: 25px;
        margin-bottom: 30px;
        animation: slideIn 0.3s ease-out;
    }

    .user-vote-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .user-vote-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #1e40af;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .user-vote-title i {
        color: #3b82f6;
    }

    .user-choice {
        background: white;
        padding: 10px 20px;
        border-radius: 15px;
        border: 2px solid #3b82f6;
        font-weight: 700;
        color: #1e40af;
    }

    .user-vote-meta {
        display: flex;
        gap: 20px;
        font-size: 14px;
        color: #1e3a8a;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    /* 操作按钮 */
    .action-buttons {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        margin-top: 30px;
    }

    .btn-action {
        flex: 1;
        min-width: 150px;
        padding: 16px;
        border-radius: 15px;
        font-size: 15px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        text-decoration: none;
        border: none;
    }

    .btn-primary-gradient {
        background: var(--primary-gradient);
        color: white;
        box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
    }

    .btn-primary-gradient:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 40px rgba(99, 102, 241, 0.4);
    }

    .btn-outline-primary {
        background: transparent;
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
    }

    .btn-outline-primary:hover {
        background: var(--primary-gradient);
        color: white;
        border-color: transparent;
        transform: translateY(-3px);
    }

    .btn-outline-secondary {
        background: transparent;
        border: 2px solid #d1d5db;
        color: var(--text-secondary);
    }

    .btn-outline-secondary:hover {
        background: #f3f4f6;
        border-color: #9ca3af;
        color: #374151;
        transform: translateY(-3px);
    }

    /* 分享按钮 */
    .share-dropdown {
        position: relative;
    }

    .share-menu {
        position: absolute;
        bottom: 100%;
        right: 0;
        background: white;
        border: 1px solid rgba(99, 102, 241, 0.1);
        border-radius: 15px;
        padding: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        display: none;
        flex-direction: column;
        gap: 10px;
        min-width: 200px;
        z-index: 1000;
        margin-bottom: 10px;
    }

    .share-menu.show {
        display: flex;
        animation: fadeInDown 0.3s ease-out;
    }

    .share-btn {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 15px;
        border: none;
        background: white;
        border-radius: 10px;
        color: var(--text-primary);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .share-btn:hover {
        background: rgba(99, 102, 241, 0.05);
        transform: translateX(5px);
    }

    .share-btn i {
        width: 20px;
        text-align: center;
    }

    .share-btn.copy i {
        color: var(--primary-color);
    }

    .share-btn.twitter i {
        color: #1da1f2;
    }

    .share-btn.facebook i {
        color: #1877f2;
    }

    .share-btn.link i {
        color: #10b981;
    }

    /* 动画效果 */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes progressAnimation {
        from {
            width: 0%;
        }
    }

    /* 响应式设计 */
    @media (max-width: 768px) {
        .results-card {
            padding: 25px 20px;
            margin: 0 10px 20px;
        }

        .results-header {
            flex-direction: column;
            gap: 15px;
        }

        .results-overview {
            grid-template-columns: 1fr;
        }

        .chart-container {
            height: 250px;
        }

        .chart-bars {
            gap: 5px;
            padding: 0 10px;
        }

        .chart-bar {
            width: 90%;
        }

        .result-content {
            margin-left: 0;
            margin-top: 40px;
        }

        .action-buttons {
            flex-direction: column;
        }

        .btn-action {
            width: 100%;
        }
    }

    /* 打印样式 */
    @media print {
        .results-card {
            box-shadow: none;
            border: 1px solid #ddd;
        }

        .action-buttons,
        .chart-controls {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="results-container">
    <!-- 投票结果卡片 -->
    <div class="results-card">
        <!-- 投票标题和元信息 -->
        <div class="results-header">
            <div>
                <h1 class="poll-title">{{ question.question_text }}</h1>
                <div class="poll-meta">
                    <div class="meta-item">
                        <i class="fas fa-user"></i>
                        <span>创建者：{{ question.author.username|default:"匿名用户" }}</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-calendar-alt"></i>
                        <span>创建时间：{{ question.pub_date|date:"Y年m月d日 H:i" }}</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-chart-bar"></i>
                        <span>总投票数：{{ question.total_votes }}</span>
                    </div>
                </div>
            </div>
            <div class="result-badge">
                <i class="fas fa-poll"></i>
                投票结果
            </div>
        </div>

        <!-- 投票统计概览 -->
        <div class="results-overview">
            {% with max_votes=question.choice_set.all|dictsort:"votes"|last %}
            <div class="overview-card highlight">
                <div class="overview-icon">
                    <i class="fas fa-trophy"></i>
                </div>
                <div class="overview-value">{{ max_votes.votes }}</div>
                <div class="overview-label">最高得票</div>
                <div class="small text-muted mt-2">{{ max_votes.choice_text|truncatechars:20 }}</div>
            </div>
            {% endwith %}

            <div class="overview-card">
                <div class="overview-icon">
                    <i class="fas fa-vote-yea"></i>
                </div>
                <div class="overview-value">{{ question.total_votes }}</div>
                <div class="overview-label">总投票数</div>
            </div>

            <div class="overview-card">
                <div class="overview-icon">
                    <i class="fas fa-list-ul"></i>
                </div>
                <div class="overview-value">{{ question.choice_set.count }}</div>
                <div class="overview-label">选项数量</div>
            </div>

            {% if question.total_votes > 0 %}
            <div class="overview-card">
                <div class="overview-icon">
                    <i class="fas fa-percentage"></i>
                </div>
                {% with top_choice=question.choice_set.all|dictsort:"votes"|last %}
                <div class="overview-value">
                    {% widthratio top_choice.votes question.total_votes 100 %}%
                </div>
                {% endwith %}
                <div class="overview-label">最高得票率</div>
            </div>
            {% endif %}
        </div>

        <!-- 用户投票信息（如果已投票） -->
        {% if user_vote %}
        <div class="user-vote-info">
            <div class="user-vote-header">
                <h3 class="user-vote-title">
                    <i class="fas fa-user-check"></i>
                    您的投票
                </h3>
                <div class="user-choice">{{ user_vote.choice.choice_text }}</div>
            </div>
            <div class="user-vote-meta">
                <div class="meta-item">
                    <i class="far fa-clock"></i>
                    <span>投票时间：{{ user_vote.vote_date|date:"m月d日 H:i" }}</span>
                </div>
                <div class="meta-item">
                    <i class="fas fa-sort-amount-up"></i>
                    <span>排名：第 {{ user_vote_rank }} 名</span>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- 投票结果图表 -->
        <div class="results-chart">
            <div class="chart-header">
                <h3 class="chart-title">
                    <i class="fas fa-chart-bar"></i>
                    投票分布图
                </h3>
                <div class="chart-controls">
                    <button class="chart-btn active" onclick="changeChartType('bar')">柱状图</button>
                    <button class="chart-btn" onclick="changeChartType('percentage')">百分比</button>
                    <button class="chart-btn" onclick="changeChartType('votes')">票数</button>
                </div>
            </div>

            <div class="chart-container" id="chartContainer">
                <div class="chart-bars" id="chartBars">
                    {% for choice in question.choice_set.all %}
                    {% with percentage=choice.votes|default:0|floatformat:1 %}
                    <div class="chart-bar-wrapper" data-choice="{{ choice.choice_text }}"
                         data-votes="{{ choice.votes }}" data-percentage="{{ percentage }}">
                        <div class="chart-bar {% if forloop.first %}winner{% endif %}"
                             style="height: {% if question.total_votes > 0 %}{% widthratio choice.votes question.total_votes 80 %}%{% else %}0%{% endif %};"
                             data-tooltip="{{ choice.choice_text }}: {{ choice.votes }}票 ({{ percentage }}%)">
                            <div class="chart-bar-value">{{ choice.votes }}票</div>
                        </div>
                        <div class="chart-bar-label">{{ choice.choice_text|truncatechars:15 }}</div>
                    </div>
                    {% endwith %}
                    {% endfor %}
                </div>
            </div>

            <div class="chart-legend">
                {% for choice in question.choice_set.all|slice:":4" %}
                <div class="legend-item {% if forloop.first %}winner{% endif %}">
                    <div class="legend-color"></div>
                    <span>{{ choice.choice_text|truncatechars:20 }}</span>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- 详细结果列表 -->
        <div class="results-list">
            <h3 class="chart-title" style="margin-bottom: 20px;">
                <i class="fas fa-list-ol"></i>
                详细结果排名
            </h3>

            {% for choice in question.choice_set.all %}
            {% with percentage=choice.votes|default:0|floatformat:1 %}
            <div class="result-item {% if forloop.first %}winner{% endif %}">
                <div class="result-rank">{{ forloop.counter }}</div>
                <div class="result-content">
                    <div class="result-header">
                        <h4 class="result-title">{{ choice.choice_text }}</h4>
                        <div class="result-stats">
                            <span class="result-votes">{{ choice.votes }} 票</span>
                            <span class="result-percentage">
                                {% if question.total_votes > 0 %}
                                {{ percentage }}%
                                {% else %}
                                0%
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    <div class="result-progress">
                        <div class="result-progress-bar"
                             style="width: {% if question.total_votes > 0 %}{% widthratio choice.votes question.total_votes 100 %}%{% else %}0%{% endif %};"
                             data-percentage="{{ percentage }}"></div>
                    </div>
                </div>
            </div>
            {% endwith %}
            {% endfor %}
        </div>

        <!-- 时间趋势图（模拟） -->
        {% if question.total_votes > 10 %}
        <div class="time-trend">
            <div class="trend-header">
                <h3 class="trend-title">
                    <i class="fas fa-chart-line"></i>
                    投票趋势
                </h3>
                <span class="small text-muted">过去24小时</span>
            </div>
            <div class="trend-chart" id="trendChart">
                <div class="trend-line"></div>
                <div class="trend-points" id="trendPoints"></div>
            </div>
            <div class="trend-labels">
                <span>昨天</span>
                <span>12小时前</span>
                <span>现在</span>
            </div>
        </div>
        {% endif %}

        <!-- 操作按钮 -->
        <div class="action-buttons">
            <a href="{% url 'polls:detail' question.id %}" class="btn-action btn-outline-primary">
                <i class="fas fa-arrow-left"></i>
                返回投票
            </a>

            <a href="{% url 'polls:index' %}" class="btn-action btn-outline-secondary">
                <i class="fas fa-home"></i>
                返回首页
            </a>

            <div class="share-dropdown">
                <button class="btn-action btn-primary-gradient" onclick="toggleShareMenu()">
                    <i class="fas fa-share-alt"></i>
                    分享结果
                </button>
                <div class="share-menu" id="shareMenu">
                    <button class="share-btn copy" onclick="copyResultsLink()">
                        <i class="fas fa-copy"></i>
                        复制链接
                    </button>
                    <button class="share-btn twitter" onclick="shareToTwitter()">
                        <i class="fab fa-twitter"></i>
                        分享到Twitter
                    </button>
                    <button class="share-btn facebook" onclick="shareToFacebook()">
                        <i class="fab fa-facebook"></i>
                        分享到Facebook
                    </button>
                    <button class="share-btn link" onclick="downloadResults()">
                        <i class="fas fa-download"></i>
                        下载结果
                    </button>
                </div>
            </div>
        </div>

        <!-- 投票说明（如果存在） -->
        {% if question.description %}
        <div class="alert alert-info mt-4">
            <div class="d-flex align-items-center">
                <i class="fas fa-info-circle me-3 text-info"></i>
                <div>
                    <strong>投票说明：</strong> {{ question.description }}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('投票结果页面加载完成 - 2025现代化设计');

        // 初始化进度条动画
        setTimeout(() => {
            document.querySelectorAll('.result-progress-bar').forEach(bar => {
                const percentage = bar.getAttribute('data-percentage') || '0';
                bar.style.width = percentage + '%';
            });
        }, 500);

        // 初始化图表动画
        setTimeout(() => {
            document.querySelectorAll('.chart-bar').forEach(bar => {
                const height = bar.style.height;
                bar.style.height = '0%';
                setTimeout(() => {
                    bar.style.transition = 'height 1s cubic-bezier(0.4, 0, 0.2, 1)';
                    bar.style.height = height;
                }, 100);
            });
        }, 300);

        // 初始化时间趋势图
        if (document.getElementById('trendChart')) {
            initTrendChart();
        }

        // 图表工具提示
        const chartBars = document.querySelectorAll('.chart-bar');
        chartBars.forEach(bar => {
            bar.addEventListener('mouseenter', function() {
                const tooltip = this.getAttribute('data-tooltip');
                if (tooltip) {
                    showTooltip(this, tooltip);
                }
            });

            bar.addEventListener('mouseleave', function() {
                hideTooltip();
            });
        });

        // 页面加载动画
        const resultsCard = document.querySelector('.results-card');
        resultsCard.style.opacity = '0';
        resultsCard.style.transform = 'translateY(30px)';

        setTimeout(() => {
            resultsCard.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
            resultsCard.style.opacity = '1';
            resultsCard.style.transform = 'translateY(0)';
        }, 100);
    });

    // 图表类型切换
    function changeChartType(type) {
        const chartBtns = document.querySelectorAll('.chart-btn');
        const chartBars = document.querySelectorAll('.chart-bar');
        const chartValues = document.querySelectorAll('.chart-bar-value');

        // 更新按钮状态
        chartBtns.forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        // 根据类型更新图表显示
        chartBars.forEach(bar => {
            const wrapper = bar.closest('.chart-bar-wrapper');
            const votes = wrapper.getAttribute('data-votes');
            const percentage = wrapper.getAttribute('data-percentage');

            if (type === 'percentage') {
                bar.style.height = percentage + '%';
            } else if (type === 'votes') {
                const maxVotes = Math.max(...Array.from(chartBars).map(b =>
                    parseInt(b.closest('.chart-bar-wrapper').getAttribute('data-votes'))
                ));
                const heightPercentage = (votes / maxVotes) * 80;
                bar.style.height = heightPercentage + '%';
            } else {
                // 默认柱状图（基于百分比）
                const total = {{ question.total_votes }};
                const heightPercentage = total > 0 ? (votes / total) * 80 : 0;
                bar.style.height = heightPercentage + '%';
            }
        });

        // 更新数值显示
        chartValues.forEach(value => {
            const wrapper = value.closest('.chart-bar-wrapper');
            const votes = wrapper.getAttribute('data-votes');
            const percentage = wrapper.getAttribute('data-percentage');

            if (type === 'percentage') {
                value.textContent = percentage + '%';
            } else if (type === 'votes') {
                value.textContent = votes + '票';
            } else {
                value.textContent = votes + '票';
            }
        });

        showToast(`已切换到${type === 'bar' ? '柱状图' : type === 'percentage' ? '百分比' : '票数'}模式`);
    }

    // 初始化时间趋势图
    function initTrendChart() {
        const trendPoints = document.getElementById('trendPoints');
        const hours = 24;
        const points = [];

        // 生成随机数据点
        for (let i = 0; i < hours; i += 3) {
            const x = (i / (hours - 1)) * 100;
            const y = 20 + Math.random() * 60;
            points.push({ x, y });
        }

        // 创建趋势点
        points.forEach(point => {
            const pointEl = document.createElement('div');
            pointEl.className = 'trend-point';
            pointEl.style.left = point.x + '%';
            pointEl.style.bottom = point.y + '%';
            trendPoints.appendChild(pointEl);
        });

        // 创建趋势线
        createTrendLine(points);
    }

    function createTrendLine(points) {
        // 这里可以添加趋势线绘制逻辑
        console.log('创建趋势线', points);
    }

    // 分享菜单
    function toggleShareMenu() {
        const menu = document.getElementById('shareMenu');
        menu.classList.toggle('show');

        // 点击其他地方关闭菜单
        if (menu.classList.contains('show')) {
            document.addEventListener('click', closeShareMenuOnClickOutside);
        }
    }

    function closeShareMenuOnClickOutside(event) {
        const menu = document.getElementById('shareMenu');
        const button = document.querySelector('.share-dropdown button');

        if (!menu.contains(event.target) && !button.contains(event.target)) {
            menu.classList.remove('show');
            document.removeEventListener('click', closeShareMenuOnClickOutside);
        }
    }

    // 复制结果链接
    function copyResultsLink() {
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => {
            showToast('链接已复制到剪贴板', 'success');
            document.getElementById('shareMenu').classList.remove('show');
        }).catch(err => {
            showToast('复制失败，请手动复制链接', 'error');
        });
    }

    // 分享到Twitter
    function shareToTwitter() {
        const url = encodeURIComponent(window.location.href);
        const text = encodeURIComponent(`看看这个投票结果："{{ question.question_text|truncatechars:100 }}"`);
        window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank');
        document.getElementById('shareMenu').classList.remove('show');
    }

    // 分享到Facebook
    function shareToFacebook() {
        const url = encodeURIComponent(window.location.href);
        window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
        document.getElementById('shareMenu').classList.remove('show');
    }

    // 下载结果
    function downloadResults() {
        // 这里可以实现结果下载功能（PDF、图片等）
        showToast('下载功能正在开发中', 'info');
        document.getElementById('shareMenu').classList.remove('show');
    }

    // 显示Toast消息
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;

        const toastContainer = document.querySelector('.messages') || createToastContainer();
        toastContainer.appendChild(toast);

        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();

        // 3秒后自动移除
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    function createToastContainer() {
        const container = document.createElement('div');
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        container.style.zIndex = '1060';
        document.body.appendChild(container);
        return container;
    }

    // 显示工具提示
    function showTooltip(element, text) {
        let tooltip = document.getElementById('custom-tooltip');
        if (!tooltip) {
            tooltip = document.createElement('div');
            tooltip.id = 'custom-tooltip';
            tooltip.style.cssText = `
                position: fixed;
                background: var(--text-primary);
                color: white;
                padding: 8px 12px;
                border-radius: 8px;
                font-size: 13px;
                font-weight: 500;
                z-index: 10000;
                pointer-events: none;
                opacity: 0;
                transition: opacity 0.2s;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            `;
            document.body.appendChild(tooltip);
        }

        tooltip.textContent = text;
        tooltip.style.opacity = '1';

        const rect = element.getBoundingClientRect();
        tooltip.style.left = (rect.left + rect.width / 2) + 'px';
        tooltip.style.top = (rect.top - 10) + 'px';
        tooltip.style.transform = 'translate(-50%, -100%)';
    }

    function hideTooltip() {
        const tooltip = document.getElementById('custom-tooltip');
        if (tooltip) {
            tooltip.style.opacity = '0';
        }
    }

    // 打印功能
    function printResults() {
        window.print();
    }

    // 键盘快捷键
    document.addEventListener('keydown', function(e) {
        // Ctrl+P 打印
        if (e.ctrlKey && e.key === 'p') {
            e.preventDefault();
            printResults();
        }

        // Ctrl+C 复制链接
        if (e.ctrlKey && e.key === 'c') {
            e.preventDefault();
            copyResultsLink();
        }

        // ESC 关闭分享菜单
        if (e.key === 'Escape') {
            document.getElementById('shareMenu').classList.remove('show');
        }
    });
</script>
{% endblock %}
