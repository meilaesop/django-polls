{% extends "polls/base.html" %}

{% block title %}投票结果 - {{ question.question_text }}{% endblock %}
{% block page_title %}投票结果{% endblock %}
{% block page_subtitle %}{{ question.question_text }}{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header bg-success text-white">
        <h4 class="mb-0"><i class="bi bi-bar-chart"></i> 投票统计结果</h4>
    </div>
    <div class="card-body">
        <div class="mb-4">
            <h5>问题：{{ question.question_text }}</h5>
            <p class="text-muted">发布时间：{{ question.pub_date|date:"Y年m月d日 H:i" }}</p>
        </div>
        
        <h6 class="mb-3">投票分布：</h6>
        <div class="list-group mb-4">
            {% for choice in question.choice_set.all %}
            <div class="list-group-item">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">{{ choice.choice_text }}</h6>
                    <span class="badge bg-primary rounded-pill">{{ choice.votes }} 票</span>
                </div>
                <!-- 进度条 -->
                {% with total=question.total_votes %}
                {% if total > 0 %}
                <div class="progress mt-2" style="height: 20px;">
                    <div class="progress-bar bg-info" 
                         role="progressbar" 
                         style="width: {% widthratio choice.votes total 100 %}%"
                         aria-valuenow="{{ choice.votes }}" 
                         aria-valuemin="0" 
                         aria-valuemax="{{ total }}">
                        {% widthratio choice.votes total 100 %}%
                    </div>
                </div>
                {% else %}
                <div class="text-muted mt-2">暂无投票</div>
                {% endif %}
                {% endwith %}
            </div>
            {% endfor %}
        </div>
        
        <div class="alert alert-info">
            <h6><i class="bi bi-info-circle"></i> 统计信息</h6>
            <p class="mb-0">
                总投票数：<strong>{{ question.total_votes }}</strong> 票
                {% if question.total_votes > 0 %}
                | 参与人数：<strong>{{ question.total_votes }}</strong> 人
                {% endif %}
            </p>
        </div>
        
        <div class="mt-4">
            <a href="{% url 'polls:detail' question.id %}" class="btn btn-primary">
                <i class="bi bi-check2-circle"></i> 重新投票
            </a>
            <a href="{% url 'polls:index' %}" class="btn btn-outline-secondary">
                <i class="bi bi-list-ul"></i> 返回列表
            </a>
            <a href="{% url 'polls:vote' question.id %}" class="btn btn-outline-info">
                <i class="bi bi-arrow-clockwise"></i> 再次投票
            </a>
        </div>
    </div>
    <div class="card-footer text-muted">
        <small>数据更新于 {% now "Y年m月d日 H:i:s" %}</small>
    </div>
</div>

<!-- 添加计算总票数的标签 -->
{% block extra_js %}
<script>
// 计算总票数
document.addEventListener('DOMContentLoaded', function() {
    const votesElements = document.querySelectorAll('.badge.bg-primary');
    let totalVotes = 0;
    votesElements.forEach(el => {
        const votes = parseInt(el.textContent.match(/\d+/)[0]);
        totalVotes += votes;
    });
    
    // 如果有总票数显示元素，更新它
    const totalElement = document.querySelector('strong');
    if (totalElement && totalElement.textContent.includes('总投票数')) {
        const parent = totalElement.closest('p');
        if (parent) {
            parent.innerHTML = parent.innerHTML.replace('{{ question.total_votes }}', totalVotes);
        }
    }
});
</script>
{% endblock %}
